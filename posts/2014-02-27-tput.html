<!DOCTYPE html>
<html lang="ja">
    <head>
        <meta charset="utf-8">
        <title>動的なCUIツールの作成について僕がはまったこと</title>
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <link href="../css/uikit.min.css" rel="stylesheet" media="screen">
        <script src="http://code.jquery.com/jquery.js"></script>
        <script src="../js/uikit.min.js"></script>
    </head>
    <body>
        <div class="uk-container uk-container-center">
            <div class="uk-navbar-brand">
                <a>Atelier lambda</a>
            </div>
        </div>
                
        <div class="uk-grid">
            <div class="uk-width-2-10">
                <div class="uk-float-right">
                    <li class="uk-nav-header">
                        <font size="5">
                            <a href="../">Home</a><br>
                            <a href="../about.html">About</a><br>
                            <a href="../contact.html">Contact</a><br>
                            <a href="../archive.html">Archive</a><br>
                        </font>
                    </li>
                </div>
            </div>

            <div class="uk-width-8-10">
                <div id="content">
                    <h1>動的なCUIツールの作成について僕がはまったこと</h1>

                    <div class="info">
    Posted on February 27, 2014
    <a href="../tags/cui.html">cui</a>, <a href="../tags/haskell.html">haskell</a>
    
</div>

<h3 id="特殊な画面制御について">特殊な画面制御について</h3>
<p>例えば僕は割とlinuxコマンドの「clear」を多用します。<br />.zshrcに</p>
<pre><code>alias cls='clear;l'</code></pre>
<p>とaliasしてます。(lはlsのalias)<br />ところで自作プログラムで画面をクリアしたい時はどうしたらいいのでしょうか？(systemコマンドとかいう邪道は考えないことにして)<br />それについては特殊な文字を表示することで解決できます。<br />ついでにカーソルを移動させたり、文字の色を変えたりできます。<br />分かりやすい表を載せているサイトがあったので紹介させて頂きます。<br /><a href="https://www.grapecity.com/tools/support/powernews/column/clang/047/page02.html">第47回 特殊な画面制御～コンソール入出力関数と … - GrapeCity</a><br />上のサイトはC言語についてですが、どの言語でも表のコードを表示するという形で実現可能です。(言語によっては制御するライブラリがあるかもしれませんが)<br />多分、Haskellにもライブラリはあるとは思うんですが僕は見つけられなかった(ここで「あ、ないの？」と思った方はとりあえずこの記事を最後まで見てください)ので<a href="https://github.com/lmdexpr/cAtelier">Haskell製自作twitter client</a>で自作するさいに上記サイトを参考にさせて頂きました。<br />ありがとうございました。<br />ちなみに言語によってエスケープの表現が違うので「\ESC」はCだと「\033」ですが、Haskellでは「\ESC」でいけます。</p>
<h3 id="環境変数">環境変数</h3>
<p>次に画面のクリアとカーソル移動ができるなら画面幅とか欲しいですよね。<br />じゃないとはみ出したり色々問題になりそうですし。<br />そこで環境変数です！<br /><span class="math">\(COLUMNSと\)</span>LINESです！！<br />その名が示す通りカラムと行の文字数を示してます。<br />よーし、ならばおじさん、これを取得して画面分割とか実装しちゃうぞー^^</p>
<p>と、思ってました。最初は……。<br />HaskellではSystem.EnvironmentのgetEnvで環境変数が取得できます。型はString -&gt; IO String。<br />適当に</p>
<pre><code>do
{
    c &lt;- getEnv &quot;COLUMNS&quot;;
    print c
}</code></pre>
<p>とかをghciから打つと分かりますが、うまくいきません。<br />え？なんで？って感じですが、ダメなんです。<br />試しにターミナルで</p>
<pre><code>echo $COLUMNS</code></pre>
<p>を打つと「100」が返ってきます。</p>
<p>ん？（＾ω＾；</p>
<p>悩みながら実装を拝見するとどうやらFFIを使ってCのgetenv関数を呼び出しているのが分かります。<br />うーん、これはちょっと追うべきじゃなさそう。<br />しかも<span class="math">\(COLUMNSでなくて\)</span>PATHで試してみるとうまく動く。<br />更に増える疑問……。</p>
<p>試しにもう一度ターミナルに戻り</p>
<pre><code>export COLUMNS</code></pre>
<p>を打つ。この時</p>
<pre><code>echo $COLUMNS</code></pre>
<p>の返り値は100。<br />あれ？これでええんか？とか思いながらghciからgetEnvを叩き、実行すると…</p>
<p>&gt;100&lt;</p>
<p>え？？？は？？？？？え？？は？？？？<br />何故だかうまくいく。ちなみにexportしてないLINESで試すとやっぱりダメ。<br />もうなんていうか<a href="https://www.google.co.jp/search?q=どういうことだってばよ&amp;tbm=isch">???</a><br />ええーい、exportでうまくいくならsystemコマンドでexportさせればええのかー！？としてみたもののダメ。<br />haskellから呼ぶのが間違いか！？と思えばシェルスクリプトで</p>
<pre><code>echo $COLUMNS</code></pre>
<p>もダメ……。<br />いよいよ分からなくなってきたところに見つけたのがこんなサイト↓<br /><a href="http://stackoverflow.com/questions/1780483/lines-and-columns-environmental-variables-lost-in-a-script">LINES and COLUMNS environmental variables lost in a script</a><br />おぉ、これだ！ってことで解決へ！！！</p>
<h3 id="tputってなんだよー">tputってなんだよー！！！</h3>
<p>どうやら上の記事や今までの実験から察するにhaskell云々というかCOLUMNS、LINESが特殊っぽい感じ?<br />とにかく$(tput cols)とか$(tput lines)でうまくいくらしいから試そう！</p>
<pre><code>export COLUMNS=$(tput cols)</code></pre>
<p>すると、どうやらうまくいったみたい！やったね、たえ(ry<br />よーし、ghciで……。<br />え……？<br />な、なんでgetEnvが例外投げてんの……？<br />冗談でしょ……？<br />というかtputってなんだ……。<br />ということでggろう。<br />その結果としてはどうやらterminfoデータベースから情報を抜いたりしてるらしい。<br />なんでも画面のクリアとかもできるんだとか。<br />え？じゃあ、そのterminfoをhaskellから触れたらええのん？</p>
<h3 id="そして最終決戦">そして、最終決戦</h3>
<p>ggりました。すると…… 。 あったどー！Hackageにterminfoパッケージがなー！！！！<br />しかも、こいつ使えば画面クリアとかカーソル移動とか色々できるっぽい！俺の一日なんだったんだ！<br />中身は大体僕が上で言ってたこととか。<br />ちゃんとtermLinesとかもあったよ。<br />なにやら返り値が「Capability Int」とか怪しいけど、これもMonadらしいし、まぁ使えるかな？<br />という訳で無事解決を迎えた僕が言いたいのはパッケージを調べようってことかな(涙目<br />そう、言ってもterminfoとか調べるにはやっぱりあそこまでいきつかないと知らないままでいそうだし、良い勉強になったかな。<br />とにかくCUIを操作するには「terminfo」ってのが重要ワード！<br />そう言えばtera termでも見た気がしなくもないけど、それは置いといて僕はそろそろ進捗を出さなきゃ。</p>
<p>twitter clientの方は方向性が固まって、今は並列プログラミングについて調べてるところ。こんなに充実のパッケージがあるんだから画面分割して使ったり、TLを見ながら呟きたいし！<br />ということでもしかしたら近々そこそこのものを公開できるかも？<br />dep hellとか今回の件とかやっぱり実際にコードを書くのが一番勉強になるなぁというところで今回はお 終いです。お疲れ様でした。</p>

                </div>
                <div id="footer">
                    <div class="uk-float-right">
                        Site proudly generated by
                        <a href="http://jaspervdj.be/hakyll">Hakyll</a>.<br>
                        This site uses
                        <a href="http://getuikit.com/index.html">UIkit</a>.<br>
                        This site's repository is
                        <a href="https://github.com/lmdexpr/lmdexpr.github.io/">lmdexpr.github.io</a>.<br>
                    </div>
                </div>
            </div>
        </div>
    </body>
</html>
